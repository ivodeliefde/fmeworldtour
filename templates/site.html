<!DOCTYPE html>
<html>
<head>

	<title>FME World Tour Demo</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="shortcut icon" type="image/x-icon" href="http://www.tensing.com//favicon.ico" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
	<script src="{{ url_for('static', filename='js/Leaflet.draw.js') }}"></script>
 <script src="{{ url_for('static', filename='js/Leaflet.Draw.Event.js') }}"></script>
 <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.draw.css') }}" />
	<script src="{{ url_for('static', filename='js/Toolbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/Tooltip.js') }}"></script>

  <script src="{{ url_for('static', filename='js/ext/GeometryUtil.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ext/LatLngUtil.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ext/LineUtil.Intersect.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ext/Polygon.Intersect.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ext/Polyline.Intersect.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ext/TouchEvents.js') }}"></script>

  <script src="{{ url_for('static', filename='js/draw/DrawToolbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/draw/handler/Draw.Feature.js') }}"></script>
  <script src="{{ url_for('static', filename='js/draw/handler/Draw.SimpleShape.js') }}"></script>
  <script src="{{ url_for('static', filename='js/draw/handler/Draw.Polyline.js') }}"></script>
  <script src="{{ url_for('static', filename='js/draw/handler/Draw.Marker.js') }}"></script>
  <script src="{{ url_for('static', filename='js/draw/handler/Draw.CircleMarker.js') }}"></script>
  <script src="{{ url_for('static', filename='js/draw/handler/Draw.Circle.js') }}"></script>
  <script src="{{ url_for('static', filename='js/draw/handler/Draw.Polygon.js') }}"></script>
  <script src="{{ url_for('static', filename='js/draw/handler/Draw.Rectangle.js') }}"></script>


  <script src="{{ url_for('static', filename='js/edit/EditToolbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit/handler/EditToolbar.Edit.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit/handler/EditToolbar.Delete.js') }}"></script>

  <script src="{{ url_for('static', filename='js/Control.Draw.js') }}"></script>

  <script src="{{ url_for('static', filename='js/edit/handler/Edit.Poly.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit/handler/Edit.SimpleShape.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit/handler/Edit.Marker.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit/handler/Edit.CircleMarker.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit/handler/Edit.Circle.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit/handler/Edit.Rectangle.js') }}"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <style>
  body {
      font: 20px Montserrat, sans-serif;
      line-height: 1.8;
      color: #ffffff;
  }
	#map {
		height: 100%;
		width: 100%;
	}
	.container {
		margin: 1vw;
		padding: 1vw;
	}

	.map-container {
		height: 70vh;
	}
  p {font-size: 16px;}
  .margin {margin-bottom: 45px;}
  .bg-1 {
      background-color: #1abc9c; /* Green */
      color: #ffffff;
			height: 20vh;
  }
  .bg-2 {
      background-color: #474e5d; /* Dark Blue */
      color: #ffffff;
  }
  .bg-3 {
      background-color: #ffffff; /* White */
      color: #555555;
  }
  .bg-4 {
      background-color: #2f2f2f; /* Black Gray */
      color: #fff;
  }
	.row {
		width: 97vw;
	}


  </style>

</head>
<body>

	<div class="jumbotron text-center bg-1">
	  <h1>Download your dataset</h1>
	  <p>Draw an area you're interested in!</p>
	</div>

	<div class="container">
	  <div class="row">
	    <div class="col-sm-8 map-container">
				<div id="map"></div>
	    </div>
	    <div id="download-panel" class="col-sm-4 bg-3"></div>
	  </div>
	</div>


<script>

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(updatePosition)
    } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
}
function updatePosition(position) {
  map.setView([position.coords.latitude, position.coords.longitude], 13);
}

var map = L.map('map').setView([52.087306, 4.288373], 13);

L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
	maxZoom: 18,
	id: 'mapbox.light'
}).addTo(map);

$(document).ready(getLocation())

// Initialise the FeatureGroup to store editable layers
var editableLayers = new L.FeatureGroup();
map.addLayer(editableLayers);

var drawPluginOptions = {
  position: 'topright',
  draw: {
    polygon: {
      allowIntersection: false, // Restricts shapes to simple polygons
      drawError: {
        color: '#e1e100', // Color the shape will turn when intersects
        message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
      },
      shapeOptions: {
        color: '#97009c'
      }
    },
    // disable toolbar item by setting it to false
    polyline: false,
    circle: false, // Turns off this drawing tool
    rectangle: false,
    marker: false,
		circlemarker: false
    },
  edit: {
    featureGroup: editableLayers, //REQUIRED!!
    remove: true
  }
};

// Initialise the draw control and pass it the FeatureGroup of editable layers
var drawControl = new L.Control.Draw(drawPluginOptions);
map.addControl(drawControl);

map.on('draw:drawstart', function(e) {
	editableLayers.eachLayer(function (layer) {
    editableLayers.removeLayer(layer);
	});
	$("#download-panel").html("")
});

map.on('draw:deleted', function(e) {
	editableLayers.eachLayer(function (layer) {
    editableLayers.removeLayer(layer);
	});
	$("#download-panel").html("")
});

map.on('draw:created', function(e) {
  var type = e.layerType,
  layer = e.layer;
  editableLayers.addLayer(layer);
	$("#download-panel").html('<form id=fmeform><div class="form-group"><div class="form-group"><label for="usr">Username:</label><input type="text" class="form-control" id="usr"></div><div class="form-group"><label for="pwd">Password:</label><input type="password" class="form-control" id="pwd"></div></div><button id="fmesubmit" type="button" class="btn btn-default">Submit</button></form>')

	$("#fmesubmit").click(function(){
		editableLayers.eachLayer(function (layer) {
			for (var f in layer._renderer._layers){
				var feature = layer._renderer._layers[f];
			}
			var userPolygon = feature.toGeoJSON();
			console.log(userPolygon)
			callFME($('#usr').val(),$('#pwd').val())
		});
	});

});


function callFME(usr,pwd){
		$.post("/callFME", {usr: usr, pwd: pwd}, function(data, status){
        alert("Data: " + data + "\nStatus: " + status);
    });

}

</script>
